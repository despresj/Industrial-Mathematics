---
title: "sim"
author: "Joe Despres"
date: "10/3/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(tictoc)
library(patchwork)
```


```{r}
sim_results <- here::here("data", "sim_results_iterations.csv") %>% 
   readr::read_csv() %>% 
  mutate(over_booking_arrivals_phat = over_nbookings - over_canceled_same_p) %>% 
  rename(over_same_phat_arrivals = over_booking_arrivals_phat)
```


```{r}
sim_results %>% 
  ggplot(aes(x = check_in_date, y = over_booking_arrivals)) + 
  stat_bin2d(aes(fill = after_stat(count)), binwidth = c(1,1)) +
  geom_hline(yintercept = 100, color = "red") + 
  labs(x = "Booking Results", y = "Number of Arrivals") + 
  scale_fill_viridis_c()
```

```{r}
library(forcats)
sim <- sim_results %>% 
  select(check_in_date,over_booking_arrivals, over_same_phat_arrivals, booking_arrivals) %>% 
  pivot_longer(cols = over_booking_arrivals:booking_arrivals, names_to = "strategy", values_to = "arrivals") %>%
  mutate(strat_name = case_when(
                                strategy == "over_booking_arrivals"   ~ "Proposed Overbooking Strategy",
                                strategy == "over_same_phat_arrivals" ~ "Overbooking with Constant P",
                                strategy == "booking_arrivals"        ~ "Booking at Capacity",
                                ),
         strat_name = fct_relevel(strat_name,
                                     "Proposed Overbooking Strategy",
                                     "Overbooking with Constant P",
                                     "Booking at Capacity"
                                     ))
```

```{r}
sim_summary <- sim %>% 
  group_by(check_in_date, strat_name) %>% 
  summarise(mean = mean(arrivals),
            x_05 = quantile(arrivals, 0.05),
            x_95 = quantile(arrivals, 0.95),
            )
```


```{r}
points <- ggplot(data = sim) + 
    geom_point(aes(x = check_in_date, y = arrivals), 
               color = "grey85", alpha = 0.1, shape = 4, size = 0.5) 
points
```

```{r}
stat_lines <- points + 
    # stat_bin2d(aes(fill = after_stat(count)), binwidth = c(1,1)) +
    geom_line(data = sim_summary, aes(x = check_in_date, y = mean),
              color = "black") +
    geom_ribbon(data = sim_summary, aes(x = check_in_date, ymin = x_05, ymax = x_95), color = "grey75")

stat_lines
```

```{r}
stat_lines +
    geom_hline(yintercept = 100, color = "red") + 
    labs(x = "Booking Results", y = "Number of Arrivals", fill = "Frequency") + 
    scale_fill_viridis_c(option = "B") + 
    facet_wrap(~strat_name, ncol = 1, scales = "free") + 
    theme_bw()

ggsave(here::here("R","figures", "Figure_sim_test.png"),
       height = 11, width = 8.5)

beepr::beep()
```
