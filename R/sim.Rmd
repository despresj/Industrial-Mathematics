---
title: "simulation"
author: "Joe Despres"
date: "9/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidymodels)
library(lubridate)
library(tictoc)
source(here::here("R", "capacity_frac.R"))
hotels <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv')
```

```{r}
hotels <- hotels %>% 
    mutate(
    check_in_date = ymd(paste(arrival_date_year, arrival_date_month,
                                      arrival_date_day_of_month)),
    reservation_date = check_in_date, 
    booking_date = check_in_date - days(lead_time),
         stay_length = stays_in_week_nights + stays_in_weekend_nights,
         check_out_date = if_else(reservation_status != "No-Show",
                                  reservation_date + days(stay_length), ymd("NA"))) %>% 
  select(booking_date, is_canceled, hotel,customer_type, adults, children, babies, lead_time, stay_length, deposit_type, check_in_date, check_out_date)

```

```{r}
hotels %>% 
  group_by(booking_date) %>% 
  count() %>% 
  filter(year(booking_date) > 2015) %>% 
  ggplot(aes(x = booking_date, y = n)) + 
  geom_line()

hotels %>% 
  group_by(check_in_date, hotel) %>% 
  count() %>% 
  filter(year(check_in_date) > 2015) %>% 
  ggplot(aes(x = check_in_date, y = n, color = hotel)) + 
  geom_line() + 
  facet_wrap(~hotel, nrow = 2)

```

```{r}
city_hotel <- hotels %>% 
  filter(hotel == "City Hotel")

training_dates <- city_hotel %>% 
  count(check_in_date) %>% 
  arrange(check_in_date) %>% 
  slice(round(0.8*n()):793) %>%  # 80% trian set 
  pull(check_in_date)


train <- city_hotel %>% 
  filter(!check_in_date %in% training_dates)
test <- city_hotel %>% 
  filter(check_in_date %in% training_dates)
```

```{r}
logistic_fit <- glm(is_canceled ~ customer_type +
                      adults + 
                      children + 
                      babies + 
                      lead_time + 
                      stay_length + 
                      deposit_type, data = train,
                      family = binomial(link = logit))
```

```{r}
capacity_frac <- function (p, rooms=100, loss=4, min_p=0.3) {
E <- 0; E_m1 <- 0; Fx <- 0;
P_overbook <- 0; bookings <- rooms;

  if(p > min_p) {
    while(E_m1 >= E) {
      E <-  bookings * Fx - (bookings - loss) * bookings * P_overbook
      Fx <-  pbinom(rooms, bookings, p, lower.tail = TRUE)
      P_overbook <-  1 - Fx
      bookings <-  bookings + 1
      E_m1 <-  bookings * Fx - (bookings - loss) * bookings * P_overbook
      }
  }
  else {
    bookings = rooms * 3
  }
  return(bookings)
}
capacity_frac(p = 0.64)

```

# Relationship between capacity and bookings
```{r}
tic()
n_to_book <- tibble(p = seq(from = 0.01, to = 0.999, by = 0.001)) %>% 
  mutate(
         rooms_10 = map_dbl(p, capacity_frac, 10, 4, 0.001),
         rooms_100 = map_dbl(p, capacity_frac, 1e2, 4, 0.001),
         rooms_1000 = map_dbl(p, capacity_frac, 1e3, 4, 0.001), 
         rooms_10000 = map_dbl(p, capacity_frac, 1e4, 4, 0.001),
         rooms_100000 = map_dbl(p, capacity_frac, 1e5, 4, 0.001)
         )
toc()
```
```{r}
n_to_book %>% 
  pivot_longer(starts_with("rooms"), names_to = "capacity", values_to = "bookings") %>% 
  ggplot(aes(x = p, y = bookings, color = capacity)) + 
  geom_line() + 
  scale_y_log10()

```



```{r}
test_pred <- test %>% 
  mutate(p_hat = predict(logistic_fit, newdata = test, type = "response"),
         cap = map_dbl(p_hat, capacity_frac),
         cap_fra = 1/cap) 
```

```{r}
sample_fn <- function(data_input) {
  success <- FALSE; i <- 1; samp <- data_input
  
  while(!success) {
    samp[i,] <- sample_n(data_input, size = 1, replace = TRUE )
    success <- sum(samp$cap_fra) > 1
    i <- i + 1
  }
  samp <- samp[1:i,]
  
  return(samp)
}
```

```{r}
test_pred %>%
  group_by(check_in_date) %>% 
  nest() %>% 
  mutate(
         count = map_dbl(data, nrow),
    sum_capacity = map_dbl(data, ~sum(.x$cap_fra)
         )) %>% 
  mutate(cheese = map(data, sample_fn))

```





